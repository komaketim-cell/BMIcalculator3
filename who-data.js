/**
 * who-data.js
 * داده‌های LMS سازمان بهداشت جهانی (WHO) برای BMI-for-age
 * برای پسران و دختران 5 تا 19 سال
 * 
 * این داده‌ها به صورت سالیانه (age به سال) ذخیره شده‌اند
 * و با درون‌یابی خطی برای سن‌های دقیق استفاده می‌شوند
 */

// ساختار داده LMS: { age (سال), L, M, S }
const WHO_LMS_BOYS = [
    { age: 5.0, L: -1.6452, M: 15.3949, S: 0.09182 },
    { age: 5.5, L: -1.7505, M: 15.4622, S: 0.09425 },
    { age: 6.0, L: -1.8497, M: 15.5309, S: 0.09663 },
    { age: 6.5, L: -1.9425, M: 15.6020, S: 0.09896 },
    { age: 7.0, L: -2.0288, M: 15.6759, S: 0.10123 },
    { age: 7.5, L: -2.1086, M: 15.7531, S: 0.10343 },
    { age: 8.0, L: -2.1819, M: 15.8342, S: 0.10557 },
    { age: 8.5, L: -2.2489, M: 15.9195, S: 0.10765 },
    { age: 9.0, L: -2.3096, M: 16.0095, S: 0.10966 },
    { age: 9.5, L: -2.3643, M: 16.1045, S: 0.11162 },
    { age: 10.0, L: -2.4134, M: 16.2047, S: 0.11352 },
    { age: 10.5, L: -2.4571, M: 16.3104, S: 0.11537 },
    { age: 11.0, L: -2.4959, M: 16.4216, S: 0.11718 },
    { age: 11.5, L: -2.5302, M: 16.5385, S: 0.11895 },
    { age: 12.0, L: -2.5606, M: 16.6608, S: 0.12068 },
    { age: 12.5, L: -2.5876, M: 16.7884, S: 0.12239 },
    { age: 13.0, L: -2.6116, M: 16.9209, S: 0.12408 },
    { age: 13.5, L: -2.6332, M: 17.0577, S: 0.12575 },
    { age: 14.0, L: -2.6527, M: 17.1983, S: 0.12742 },
    { age: 14.5, L: -2.6706, M: 17.3419, S: 0.12908 },
    { age: 15.0, L: -2.6871, M: 17.4876, S: 0.13075 },
    { age: 15.5, L: -2.7024, M: 17.6346, S: 0.13243 },
    { age: 16.0, L: -2.7167, M: 17.7817, S: 0.13412 },
    { age: 16.5, L: -2.7300, M: 17.9281, S: 0.13582 },
    { age: 17.0, L: -2.7425, M: 18.0729, S: 0.13754 },
    { age: 17.5, L: -2.7542, M: 18.2150, S: 0.13928 },
    { age: 18.0, L: -2.7651, M: 18.3536, S: 0.14103 },
    { age: 18.5, L: -2.7753, M: 18.4879, S: 0.14280 },
    { age: 19.0, L: -2.7847, M: 18.6171, S: 0.14458 }
];

const WHO_LMS_GIRLS = [
    { age: 5.0, L: -1.3830, M: 15.1842, S: 0.09121 },
    { age: 5.5, L: -1.4970, M: 15.2520, S: 0.09364 },
    { age: 6.0, L: -1.6058, M: 15.3220, S: 0.09605 },
    { age: 6.5, L: -1.7093, M: 15.3949, S: 0.09844 },
    { age: 7.0, L: -1.8076, M: 15.4712, S: 0.10081 },
    { age: 7.5, L: -1.9008, M: 15.5514, S: 0.10315 },
    { age: 8.0, L: -1.9890, M: 15.6358, S: 0.10547 },
    { age: 8.5, L: -2.0725, M: 15.7247, S: 0.10777 },
    { age: 9.0, L: -2.1514, M: 15.8185, S: 0.11005 },
    { age: 9.5, L: -2.2259, M: 15.9172, S: 0.11231 },
    { age: 10.0, L: -2.2962, M: 16.0210, S: 0.11456 },
    { age: 10.5, L: -2.3626, M: 16.1299, S: 0.11680 },
    { age: 11.0, L: -2.4252, M: 16.2439, S: 0.11903 },
    { age: 11.5, L: -2.4843, M: 16.3629, S: 0.12126 },
    { age: 12.0, L: -2.5401, M: 16.4867, S: 0.12349 },
    { age: 12.5, L: -2.5928, M: 16.6150, S: 0.12573 },
    { age: 13.0, L: -2.6426, M: 16.7474, S: 0.12798 },
    { age: 13.5, L: -2.6897, M: 16.8835, S: 0.13025 },
    { age: 14.0, L: -2.7343, M: 17.0227, S: 0.13253 },
    { age: 14.5, L: -2.7765, M: 17.1643, S: 0.13484 },
    { age: 15.0, L: -2.8164, M: 17.3077, S: 0.13717 },
    { age: 15.5, L: -2.8542, M: 17.4520, S: 0.13953 },
    { age: 16.0, L: -2.8899, M: 17.5966, S: 0.14191 },
    { age: 16.5, L: -2.9237, M: 17.7405, S: 0.14432 },
    { age: 17.0, L: -2.9557, M: 17.8829, S: 0.14675 },
    { age: 17.5, L: -2.9859, M: 18.0230, S: 0.14921 },
    { age: 18.0, L: -3.0145, M: 18.1598, S: 0.15169 },
    { age: 18.5, L: -3.0415, M: 18.2926, S: 0.15420 },
    { age: 19.0, L: -3.0670, M: 18.4206, S: 0.15673 }
];

/**
 * درون‌یابی خطی بین دو نقطه LMS
 * @param {Array} lmsData - آرایه داده‌های LMS مرتب شده بر اساس age
 * @param {number} ageYears - سن دقیق بر حسب سال (مثلاً 7.5)
 * @returns {Object} - {L, M, S} درون‌یابی شده
 */
function interpolateLMS(lmsData, ageYears) {
    // اگر سن کمتر از حداقل باشد
    if (ageYears <= lmsData[0].age) {
        return { ...lmsData[0] };
    }
    
    // اگر سن بیشتر از حداکثر باشد
    if (ageYears >= lmsData[lmsData.length - 1].age) {
        return { ...lmsData[lmsData.length - 1] };
    }
    
    // پیدا کردن دو نقطه مجاور
    for (let i = 0; i < lmsData.length - 1; i++) {
        const p1 = lmsData[i];
        const p2 = lmsData[i + 1];
        
        if (p1.age <= ageYears && ageYears <= p2.age) {
            // درون‌یابی خطی
            const t = (ageYears - p1.age) / (p2.age - p1.age);
            
            return {
                age: ageYears,
                L: p1.L + t * (p2.L - p1.L),
                M: p1.M + t * (p2.M - p1.M),
                S: p1.S + t * (p2.S - p1.S)
            };
        }
    }
    
    // اگر چیزی پیدا نشد (نباید اتفاق بیفته)
    return { ...lmsData[lmsData.length - 1] };
}

/**
 * دریافت پارامترهای LMS برای سن و جنسیت مشخص
 * @param {number} ageYears - سن دقیق بر حسب سال
 * @param {string} gender - 'male' یا 'female'
 * @returns {Object|null} - {L, M, S} یا null اگر خارج از محدوده باشد
 */
function getLMS(ageYears, gender) {
    // محدوده سنی: 5 تا 19 سال
    if (ageYears < 5.0 || ageYears > 19.0) {
        return null;
    }
    
    const lmsData = gender === 'male' ? WHO_LMS_BOYS : WHO_LMS_GIRLS;
    return interpolateLMS(lmsData, ageYears);
}

/**
 * محاسبه Z-Score با استفاده از روش LMS
 * @param {number} value - مقدار اندازه‌گیری شده (BMI)
 * @param {number} L - پارامتر L
 * @param {number} M - پارامتر M (میانه)
 * @param {number} S - پارامتر S (ضریب تغییرات)
 * @returns {number} - Z-Score
 */
function calculateZScore(value, L, M, S) {
    if (L === 0) {
        return Math.log(value / M) / S;
    }
    return (Math.pow(value / M, L) - 1) / (L * S);
}

/**
 * طبقه‌بندی وضعیت بر اساس Z-Score (استاندارد WHO)
 * @param {number} z - Z-Score
 * @returns {string} - دسته‌بندی وضعیت
 */
function classifyZScore(z) {
    if (z < -3) return 'لاغری شدید';
    if (z < -2) return 'لاغری';
    if (z <= 1) return 'نرمال';
    if (z <= 2) return 'اضافه وزن';
    if (z <= 3) return 'چاقی';
    return 'چاقی شدید';
}
